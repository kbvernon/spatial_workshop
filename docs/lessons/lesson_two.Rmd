
---
title: "GIS Operations in R"
subtitle: "Working with Spatial and Attribute Data"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [xaringan-themer.css, custom_style.css]
    nature:
      highlightStyle: magula
      highlightLines: TRUE
      countIncrementalSlides: TRUE
      ratio: '16:9'
---

```{r, echo = FALSE, child = here::here("lessons/before_chunk.Rmd")}
```

## Outline

.pull-lleft[

<p style="margin-bottom:1.65em;"></p>

.bg-white.b--dark-gray.ba.bw1.br2.shadow-5.ph2.pv1.mh1.mt3.w-100[

1. Setup

2. Rasters
  * Attribute operations
  * Spatial operations
    
2. Vectors
  * Attribute operations
  * Spatial operations

]

]

.pull-lright[

```{r, echo = FALSE, fig.width = 800/72, fig.asp = 0.8, out.width = "90%", fig.align = "right"}

par(pty = "s",
    mfrow = c(1, 2),
    mar = c(2,2,2,0),
    oma = rep(1, 4))

plot(0,
     type = "n",
     xlim = c(0, 10),
     ylim = c(0, 10),
     xlab = "",
     ylab = "",
     xaxs = "i",
     yaxs = "i",
     xaxt = "n",
     yaxt = "n")

title(main = "Vector", 
      adj = 0, 
      line = 0.3,
      cex.main = 2)

xy <- par("usr")

rect(xleft = xy[1],
     xright = xy[2],
     ybottom = xy[3],
     ytop = xy[4],
     col = adjustcolor("#d4fcf5", alpha.f = 0.3))

box()

rect(xleft = 5,
     xright = 9,
     ybottom = 2,
     ytop = 6,
     col = adjustcolor("#de8500", alpha.f = 0.9),
     border = "#693f00",
     lwd = 3)

set.seed(12345)

n <- 20

x <- pmin(9.7, pmax(0.3, rnorm(n, mean = 3, sd = 1.5)))
y <- pmin(9.7, pmax(0.3, rnorm(n, mean = 6, sd = 1.5)))

points(x = x,
       y = y,
       bg = adjustcolor("#edc600", alpha.f = 0.6),
       col = "#967e02",
       pch = 21,
       lwd = 2,
       cex = 4)

lines(x = c(0.3, 0.3, 2.0, 2.5, 8.5, 9.8, 9.8),
      y = c(7.0, 0.3, 2.5, 1.5, 6.5, 9.8, 0.3),
      col = adjustcolor("#fffb00", alpha.f = 0.5),
      lwd = 10)

lines(x = c(0.3, 0.3, 2.0, 2.5, 8.5, 9.8, 9.8),
      y = c(7.0, 0.3, 2.5, 1.5, 6.5, 9.8, 0.3),
      col = "#d44402",
      lwd = 5)



m <- matrix(runif(100, min = 0, max = 100),
            nrow = 10,
            ncol = 10)

image(x = seq(0.5, 9.5, by = 1),
      y = seq(0.5, 9.5, by = 1),
      z = m,
      col = terrain.colors(100),
      xlim = c(0, 10),
      ylim = c(0, 10),
      xlab = "",
      ylab = "",
      xaxt = "n",
      yaxt = "n")

title(main = "Raster", 
      adj = 0, 
      line = 0.3,
      cex.main = 2)

grid(nx = 10,
     ny = 10,
     lty = 1,
     col = "gray50")

box()

```

]

---

## Setup

```{r, eval = FALSE}

install.packagess(c("dplyr", "tidyr"))

```

```{r}

library(here)
library(raster)
library(sf)
library(spData)
library(spDataLarge)
library(tidyr)
library(dplyr)

```

```{r, echo = FALSE}

select <- dplyr::select

```

--
count: false

__Note!__ 

.bg-white.b--dark-gray.ba.bw1.br2.shadow-5.pa2.mt0[

`dplyr` and `raster` both contain a `select()` function. This may lead to namespace collisions.

]


---

## Rasters

.pull-left[

```{r plot-elevation, fig.show = "hide"}

fn <- system.file("raster/srtm.tif", 
                  package = "spDataLarge")

elevation <- raster(fn)

plot(elevation)

```

]

.pull-right[

```{r ref.label = "plot-elevation", echo = FALSE, fig.width = 500/72, fig.asp = 0.9}
```

]


---

## Subsetting

.pull-left[

By row and column

```{r}

# with [1, 1] being top-left
elevation[2, 3]

```

By cell number

```{r}

elevation[468]

```

]

.pull-right[

By coordinates

```{r}

x <- xmin(elevation) + c(0.1, 0.2, 0.3)
y <- ymin(elevation) + c(0.1, 0.2, 0.3)

# extract
raster::extract(elevation, cbind(x, y))

```

]


---

## Smoothing

```{r, eval = FALSE}

# use NAonly = TRUE to smooth only empty pixels
focal(elevation, w = matrix(1, nrow = 3, ncol = 3), fun = min)

```

```{r, echo = FALSE, out.width = "70%"}

knitr::include_graphics("https://geocompr.robinlovelace.net/figures/04_focal_example.png")

```



---

## Vectors

```{r}

gpkg <- here("gis", "project.gpkg")

st_layers(gpkg)

world <- read_sf(gpkg, layer = "world")

states <- read_sf(gpkg, layer = "states")

```



---
class: bg_pipe

## Piping

<br><br><br><br><br><br>

.bg-white-60.br3.pa2.center[
Some basic rules:

`x %>% f` is equivalent to `f(x)`  
`x %>% f(y)` is equivalent to `f(x, y)`  
`x %>% f %>% g` is equivalent to `g(f(x))` &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
]


---

## `select()` columns

```{r}

world %>% select(name_long)

```

---

## `filter()` rows

```{r}

world %>% filter(area_km2 < 10000)

```


---

## `mutate()` variables

```{r}

world %>% 
  mutate(pop_dens = (pop / area_km2),
         gdp_dens = (gdpPercap / area_km2)) %>% 
  select(name_long, pop_dens, gdp_dens)

```


---

## `rename()` variables

```{r}

world %>% 
  rename("area" = area_km2) %>% 
  names()

```



---

## `summarize()` groups

.pull-left[

```{r}

states %>% 
  # do something here
  # do another thing
  st_geometry() %>% 
  plot()

```

]

.pull-right[

```{r}

states %>% 
  group_by(REGION) %>% 
  summarize(mean_area = mean(AREA)) %>% 
  st_geometry() %>% 
  plot()

```

]


---

## `summarize()` groups

```{r}

states %>% 
  select(NAME, REGION, AREA, ttl__15) %>% 
  group_by(REGION) %>% 
  summarize(pop = sum(ttl__15),
            n_states = n()) %>%
  st_drop_geometry()
  
```


---

## `*_join()` tables

```{r}

world_coffee <- world %>% left_join(coffee_data)

select(world_coffee, name_long, coffee_production_2017)

```


---

## `*_join()` tables

```{r, eval = FALSE}

plot(world_coffee["coffee_production_2017"])

```

```{r, echo = FALSE, fig.asp = 0.4, fig.width = 900/72, out.width = "75%"}

plot(world_coffee["coffee_production_2017"], key.pos = NULL, main = NULL)

```


---

## `st_filter()` geometries

.pull-left[

```{r}

# sample
rand_ohs <- states %>% 
  st_sample(size = 100) %>% 
  st_sf()

```

```{r, echo = FALSE}

plot(st_geometry(states))

plot(rand_ohs, 
     pch = 19, 
     col = "gray85", 
     cex = 1.2, 
     add = TRUE)

```

]

--
count: false

.pull-right[

```{r}

the_west <- states %>% filter(REGION == "West")
# spatial filter
westers <- rand_ohs %>% 
  st_filter(the_west, .predicate = st_intersects)

```

```{r, echo = FALSE}

plot(st_geometry(states))

plot(rand_ohs, 
     pch = 19, 
     col = "gray85", 
     cex = 1.2, 
     add = TRUE)

plot(westers, 
     pch = 21, 
     bg = adjustcolor("red", alpha.f = 0.5), 
     col = "red3", 
     cex = 1.5, 
     add = TRUE)

```

]


---

## `st_filter()` geometries

.pull-left[

```{r}

goats <- rand_ohs %>% 
  st_filter(the_west, 
            .predicate = st_is_within_distance, 
            dist = 500000)

```

```{r, echo = FALSE}

plot(st_geometry(states))

plot(rand_ohs, 
     pch = 19, 
     col = "gray85", 
     cex = 1.2, 
     add = TRUE)

plot(goats, 
     pch = 21, 
     bg = adjustcolor("blue", alpha.f = 0.5), 
     col = "navyblue", 
     cex = 1.5, 
     add = TRUE)

```

]

--
count: false

.pull-right[

```{r, echo = FALSE}

st_not_intersects <- function(x, y, ...) {
  
  bob <- st_intersects(x, y, ...)
  
  tom <- vector("list", length(bob))
  
  tom[which(lengths(bob) == 0)] <- 1
  
  return(tom)
  
}

```

```{r}

easters <- rand_ohs %>% 
  # made-up function 
  st_filter(the_west, 
            .predicate = st_not_intersects)

```

```{r, echo = FALSE}

plot(st_geometry(states))

plot(rand_ohs, 
     pch = 19, 
     col = "gray85", 
     cex = 1.2, 
     add = TRUE)

plot(easters, 
     pch = 21, 
     bg = adjustcolor("#fcba03", alpha.f = 0.5), 
     col = "#876300", 
     cex = 1.5, 
     add = TRUE)

```

]

---

## `st_join()` geometries

